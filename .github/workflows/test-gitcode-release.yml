name: æµ‹è¯• Release å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'é€‰æ‹©å‘å¸ƒå¹³å°'
        required: true
        type: choice
        options:
          - GitCode
          - Gitee
        default: 'GitCode'
      
      tag_name:
        description: 'ç‰ˆæœ¬æ ‡ç­¾'
        required: true
        default: 'v1.0.0'
      
      repo_name:
        description: 'ä»“åº“åç§°'
        required: true
        default: 'test-release'
      
      username:
        description: 'ç”¨æˆ·åï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰'
        required: false
        default: ''

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
        run: |
          mkdir -p files
          echo "# Test Release for ${{ inputs.platform }}" > files/README.md
          echo "Version: ${{ inputs.tag_name }}" > files/version.txt
          echo "Platform: ${{ inputs.platform }}" > files/platform.txt
          date > files/build-time.txt

      - name: æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        run: |
          echo "==================== å‘å¸ƒé…ç½® ===================="
          echo "å¹³å°: ${{ inputs.platform }}"
          echo "æ ‡ç­¾: ${{ inputs.tag_name }}"
          echo "ä»“åº“: ${{ inputs.repo_name }}"
          echo "ç”¨æˆ·: ${{ inputs.username || '(ä½¿ç”¨é»˜è®¤)' }}"
          echo "================================================="

      - name: ğŸš€ å‘å¸ƒåˆ° GitCode
        if: inputs.platform == 'GitCode'
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          USERNAME: ${{ inputs.username || 'whzhni' }}
          REPO_NAME: ${{ inputs.repo_name }}
          TAG_NAME: ${{ inputs.tag_name }}
          RELEASE_TITLE: "Release ${{ inputs.tag_name }}"
          RELEASE_BODY: |
            ## ğŸ“¦ è‡ªåŠ¨å‘å¸ƒæµ‹è¯•
            
            - ç‰ˆæœ¬: ${{ inputs.tag_name }}
            - å¹³å°: GitCode
            - æ„å»ºæ—¶é—´: ${{ github.event.repository.updated_at }}
            - è§¦å‘è€…: @${{ github.actor }}
          UPLOAD_FILES: "files/README.md files/version.txt files/platform.txt files/build-time.txt"
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          .github/workflows/scripts/release-GitCode.sh

      - name: ğŸš€ å‘å¸ƒåˆ° Gitee
        if: inputs.platform == 'Gitee'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          USERNAME: ${{ inputs.username || secrets.GITEE_USERNAME }}
          REPO_NAME: ${{ inputs.repo_name }}
          TAG_NAME: ${{ inputs.tag_name }}
          RELEASE_TITLE: "Release ${{ inputs.tag_name }}"
          RELEASE_BODY: |
            ## ğŸ“¦ è‡ªåŠ¨å‘å¸ƒæµ‹è¯•
            
            - ç‰ˆæœ¬: ${{ inputs.tag_name }}
            - å¹³å°: Gitee
            - æ„å»ºæ—¶é—´: ${{ github.event.repository.updated_at }}
            - è§¦å‘è€…: @${{ github.actor }}
          UPLOAD_FILES: "files/README.md files/version.txt files/platform.txt files/build-time.txt"
        run: |
          chmod +x .github/workflows/scripts/release-gitee.sh
          .github/workflows/scripts/release-gitee.sh

      - name: âœ… å‘å¸ƒå®Œæˆ
        run: |
          echo "::notice::ğŸ‰ æˆåŠŸå‘å¸ƒåˆ° ${{ inputs.platform }}"
          
          if [ "${{ inputs.platform }}" = "GitCode" ]; then
            echo "::notice::ğŸ”— https://gitcode.com/${{ inputs.username || 'whzhni' }}/${{ inputs.repo_name }}/releases"
          else
            echo "::notice::ğŸ”— https://gitee.com/${{ inputs.username || secrets.GITEE_USERNAME }}/${{ inputs.repo_name }}/releases"
          fi

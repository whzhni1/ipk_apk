name: æµ‹è¯• GitCode Release å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒæ ‡ç­¾åï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰'
        required: true
        default: 'v1.0.0'
      release_title:
        description: 'å‘å¸ƒæ ‡é¢˜'
        required: false
        default: ''
      repo_name:
        description: 'ä»“åº“åç§°'
        required: false
        default: 'test-release'
      delete_old_tags:
        description: 'æ˜¯å¦åˆ é™¤æ—§æ ‡ç­¾'
        required: false
        type: boolean
        default: true

env:
  USERNAME: whzhni
  REPO_NAME: ${{ inputs.repo_name }}
  TAG_NAME: ${{ inputs.tag_name }}

jobs:
  test-gitcode-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å‡†å¤‡æµ‹è¯•æ–‡ä»¶
        run: |
          echo "========================================="
          echo "ðŸ“¦ ç”Ÿæˆæµ‹è¯•æ–‡ä»¶"
          echo "========================================="
          echo ""
          
          # åˆ›å»ºæµ‹è¯•ç›®å½•
          mkdir -p release-files
          
          # ç”Ÿæˆ README.md
          cat > release-files/README.md << EOF
          # ${{ env.REPO_NAME }}
          
          æµ‹è¯• GitCode Release è‡ªåŠ¨å‘å¸ƒåŠŸèƒ½
          
          ## å‘å¸ƒä¿¡æ¯
          
          - **ç‰ˆæœ¬**: ${{ env.TAG_NAME }}
          - **æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          - **è§¦å‘è€…**: ${{ github.actor }}
          - **å·¥ä½œæµ**: ${{ github.workflow }}
          
          ## è‡ªåŠ¨ç”Ÿæˆ
          
          æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º
          EOF
          
          # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          cat > release-files/version.txt << EOF
          ç‰ˆæœ¬å·: ${{ env.TAG_NAME }}
          å‘å¸ƒæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          ä»“åº“: ${{ env.USERNAME }}/${{ env.REPO_NAME }}
          è§¦å‘è€…: ${{ github.actor }}
          å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}
          EOF
          
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          cat > release-files/CHANGELOG.md << EOF
          # æ›´æ–°æ—¥å¿— ${{ env.TAG_NAME }}
          
          å‘å¸ƒæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          ## æ–°å¢žåŠŸèƒ½
          - âœ¨ æµ‹è¯•åŠŸèƒ½ A
          - âœ¨ æµ‹è¯•åŠŸèƒ½ B
          - âœ¨ æµ‹è¯•åŠŸèƒ½ C
          
          ## é—®é¢˜ä¿®å¤
          - ðŸ› ä¿®å¤æµ‹è¯•é—®é¢˜ 1
          - ðŸ› ä¿®å¤æµ‹è¯•é—®é¢˜ 2
          
          ## æ€§èƒ½ä¼˜åŒ–
          - âš¡ ä¼˜åŒ–æµ‹è¯•æ€§èƒ½
          - âš¡ å‡å°‘èµ„æºå ç”¨
          
          ## å…¶ä»–
          - ðŸ“ æ›´æ–°æ–‡æ¡£
          - ðŸŽ¨ æ”¹è¿›ä»£ç æ ¼å¼
          EOF
          
          # ç”Ÿæˆç®€å•çš„é…ç½®æ–‡ä»¶
          cat > release-files/config.json << EOF
          {
            "version": "${{ env.TAG_NAME }}",
            "release_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ env.USERNAME }}/${{ env.REPO_NAME }}",
            "platform": "GitCode",
            "build_number": ${{ github.run_number }},
            "workflow_run_id": "${{ github.run_id }}"
          }
          EOF
          
          # ç”Ÿæˆæµ‹è¯•æ•°æ®æ–‡ä»¶
          cat > release-files/test-data.txt << EOF
          è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ•°æ®æ–‡ä»¶
          
          åŒ…å«çš„æµ‹è¯•ä¿¡æ¯ï¼š
          - ç‰ˆæœ¬: ${{ env.TAG_NAME }}
          - æ—¶é—´: $(date)
          - éšæœºæ•°: $RANDOM
          - UUID: $(cat /proc/sys/kernel/random/uuid)
          
          æµ‹è¯•å†…å®¹ï¼š
          Lorem ipsum dolor sit amet, consectetur adipiscing elit.
          Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
          Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
          EOF
          
          echo ""
          echo "âœ… æµ‹è¯•æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo ""
          echo "ðŸ“ æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh release-files/
          echo ""
          echo "ðŸ“Š æ–‡ä»¶è¯¦æƒ…ï¼š"
          for file in release-files/*; do
            if [ -f "$file" ]; then
              echo ""
              echo "ðŸ“„ $(basename $file):"
              echo "   å¤§å°: $(du -h "$file" | cut -f1)"
              echo "   è¡Œæ•°: $(wc -l < "$file")"
              echo "   MD5: $(md5sum "$file" | cut -d' ' -f1)"
            fi
          done

      - name: æ˜¾ç¤ºæ–‡ä»¶å†…å®¹é¢„è§ˆ
        run: |
          echo ""
          echo "========================================="
          echo "ðŸ‘€ æ–‡ä»¶å†…å®¹é¢„è§ˆ"
          echo "========================================="
          echo ""
          
          for file in release-files/*; do
            if [ -f "$file" ]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "ðŸ“„ æ–‡ä»¶: $(basename $file)"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              head -n 10 "$file"
              lines=$(wc -l < "$file")
              if [ $lines -gt 10 ]; then
                echo "... (è¿˜æœ‰ $((lines - 10)) è¡Œ)"
              fi
              echo ""
            fi
          done

      - name: ä¿®æ”¹è„šæœ¬é…ç½®
        run: |
          echo "========================================="
          echo "âš™ï¸  é…ç½®å‘å¸ƒè„šæœ¬"
          echo "========================================="
          echo ""
          
          SCRIPT_PATH=".github/workflows/scripts/release-GitCode.sh"
          
          # å¤‡ä»½åŽŸå§‹è„šæœ¬
          cp "$SCRIPT_PATH" "${SCRIPT_PATH}.backup"
          
          # åŠ¨æ€ä¿®æ”¹è„šæœ¬ä¸­çš„é…ç½®
          sed -i "s/^REPO_NAME=.*/REPO_NAME=\"${{ env.REPO_NAME }}\"/" "$SCRIPT_PATH"
          sed -i "s/^TAG_NAME=.*/TAG_NAME=\"${{ env.TAG_NAME }}\"/" "$SCRIPT_PATH"
          
          # è®¾ç½® Release æ ‡é¢˜
          RELEASE_TITLE="${{ inputs.release_title }}"
          if [ -z "$RELEASE_TITLE" ]; then
            RELEASE_TITLE="Release ${{ env.TAG_NAME }}"
          fi
          sed -i "s/^RELEASE_TITLE=.*/RELEASE_TITLE=\"${RELEASE_TITLE}\"/" "$SCRIPT_PATH"
          
          # è®¾ç½®è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
          UPLOAD_FILES="release-files/README.md release-files/version.txt release-files/CHANGELOG.md release-files/config.json release-files/test-data.txt"
          sed -i "s|^UPLOAD_FILES=.*|UPLOAD_FILES=\"${UPLOAD_FILES}\"|" "$SCRIPT_PATH"
          
          # è®¾ç½® Release æè¿°
          RELEASE_BODY="## ðŸ“¦ Release ${{ env.TAG_NAME }}

          å‘å¸ƒæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)

          ### ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬å·**: ${{ env.TAG_NAME }}
          - **ä»“åº“**: ${{ env.USERNAME }}/${{ env.REPO_NAME }}
          - **æž„å»ºå·**: #${{ github.run_number }}
          - **å·¥ä½œæµ**: ${{ github.workflow }}

          ### ðŸŽ¯ æœ¬æ¬¡æ›´æ–°
          - âœ¨ æ–°å¢žæµ‹è¯•åŠŸèƒ½ A
          - âœ¨ æ–°å¢žæµ‹è¯•åŠŸèƒ½ B  
          - ðŸ› ä¿®å¤æµ‹è¯•é—®é¢˜
          - âš¡ æ€§èƒ½ä¼˜åŒ–

          ### ðŸ“ å‘å¸ƒæ–‡ä»¶
          - \`README.md\` - é¡¹ç›®è¯´æ˜Ž
          - \`version.txt\` - ç‰ˆæœ¬ä¿¡æ¯
          - \`CHANGELOG.md\` - æ›´æ–°æ—¥å¿—
          - \`config.json\` - é…ç½®æ–‡ä»¶
          - \`test-data.txt\` - æµ‹è¯•æ•°æ®

          ---
          ðŸ¤– æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º"
          
          # ä½¿ç”¨ awk æ›¿æ¢å¤šè¡Œå†…å®¹
          awk -v new="$RELEASE_BODY" '
            /^RELEASE_BODY=/ {
              print "RELEASE_BODY=\"" new "\""
              in_var=1
              next
            }
            in_var && /^[A-Z_]+=/ {
              in_var=0
            }
            !in_var {
              print
            }
          ' "$SCRIPT_PATH" > "${SCRIPT_PATH}.tmp"
          mv "${SCRIPT_PATH}.tmp" "$SCRIPT_PATH"
          
          echo "âœ… è„šæœ¬é…ç½®å®Œæˆ"
          echo ""
          echo "ðŸ“ å½“å‰é…ç½®ï¼š"
          echo "  ä»“åº“å: ${{ env.REPO_NAME }}"
          echo "  æ ‡ç­¾å: ${{ env.TAG_NAME }}"
          echo "  æ ‡é¢˜: ${RELEASE_TITLE}"
          echo "  ä¸Šä¼ æ–‡ä»¶: $(echo $UPLOAD_FILES | wc -w) ä¸ª"

      - name: èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          echo "âœ… è„šæœ¬æƒé™å·²è®¾ç½®"

      - name: æ‰§è¡Œ GitCode Release å‘å¸ƒ
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          echo ""
          echo "========================================="
          echo "ðŸš€ å¼€å§‹æ‰§è¡Œ GitCode Release å‘å¸ƒ"
          echo "========================================="
          echo ""
          
          # æ£€æŸ¥ Token
          if [ -z "$GITCODE_TOKEN" ]; then
            echo "âŒ GITCODE_TOKEN æœªè®¾ç½®"
            echo "è¯·åœ¨ä»“åº“ Settings â†’ Secrets ä¸­æ·»åŠ  GITCODE_TOKEN"
            exit 1
          fi
          
          # æ‰§è¡Œè„šæœ¬
          .github/workflows/scripts/release-GitCode.sh

      - name: ç”Ÿæˆå‘å¸ƒæŠ¥å‘Š
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "ðŸ“Š å‘å¸ƒæŠ¥å‘Š"
          echo "========================================="
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ“¦ GitCode Release æµ‹è¯•æŠ¥å‘Š
          
          **å‘å¸ƒæ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)  
          **è§¦å‘è€…**: ${{ github.actor }}  
          **å·¥ä½œæµè¿è¡Œ**: #${{ github.run_number }}
          
          ---
          
          ## ðŸ“‹ å‘å¸ƒä¿¡æ¯
          
          | é¡¹ç›® | å†…å®¹ |
          |------|------|
          | ä»“åº“ | ${{ env.USERNAME }}/${{ env.REPO_NAME }} |
          | æ ‡ç­¾ | \`${{ env.TAG_NAME }}\` |
          | æ ‡é¢˜ | ${{ inputs.release_title || env.TAG_NAME }} |
          | åˆ†æ”¯ | \`main\` |
          
          ---
          
          ## ðŸ“ å‘å¸ƒæ–‡ä»¶
          
          EOF
          
          for file in release-files/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              lines=$(wc -l < "$file")
              echo "- ðŸ“„ \`$filename\` ($size, $lines è¡Œ)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          ## ðŸ”— è®¿é—®é“¾æŽ¥
          
          - ðŸŒ **GitCode ä»“åº“**: https://gitcode.com/${{ env.USERNAME }}/${{ env.REPO_NAME }}
          - ðŸ·ï¸ **Release é¡µé¢**: https://gitcode.com/${{ env.USERNAME }}/${{ env.REPO_NAME }}/-/releases/${{ env.TAG_NAME }}
          - ðŸ“‹ **æ ‡ç­¾é¡µé¢**: https://gitcode.com/${{ env.USERNAME }}/${{ env.REPO_NAME }}/-/tags/${{ env.TAG_NAME }}
          
          ---
          
          ## âš™ï¸ é…ç½®è¯´æ˜Ž
          
          å¦‚æžœå‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š
          
          1. **Token é…ç½®**: ç¡®ä¿åœ¨ä»“åº“ Settings â†’ Secrets ä¸­æ·»åŠ äº† \`GITCODE_TOKEN\`
          2. **Token æƒé™**: ç¡®ä¿ Token æœ‰ \`api\`ã€\`write_repository\` æƒé™
          3. **ä»“åº“åç§°**: ç¡®ä¿ä»“åº“å \`${{ env.REPO_NAME }}\` å¯ç”¨
          4. **ç”¨æˆ·å**: ç¡®ä¿ç”¨æˆ·å \`${{ env.USERNAME }}\` æ­£ç¡®
          
          ---
          
          ## ðŸ“– æµ‹è¯•è¯´æ˜Ž
          
          æœ¬æ¬¡æµ‹è¯•æ‰§è¡Œäº†ä»¥ä¸‹æ“ä½œï¼š
          
          1. âœ… ç”Ÿæˆäº† 5 ä¸ªæµ‹è¯•æ–‡ä»¶
          2. âœ… é…ç½®äº†å‘å¸ƒè„šæœ¬å‚æ•°
          3. âœ… æ‰§è¡Œäº† GitCode Release å‘å¸ƒè„šæœ¬
          4. âœ… è‡ªåŠ¨æ£€æµ‹å¹¶åˆ›å»ºä»“åº“ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
          5. âœ… è‡ªåŠ¨æ£€æµ‹å¹¶åˆ›å»º main åˆ†æ”¯ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
          6. âœ… åˆ é™¤æ—§æ ‡ç­¾ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          7. âœ… åˆ›å»ºæ–°çš„ Release
          8. âœ… ä¸Šä¼ æ–‡ä»¶åˆ° Release
          
          EOF

      - name: ä¸Šä¼ æµ‹è¯•æ–‡ä»¶ä¸ºå·¥ä½œæµæž„ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-files-${{ env.TAG_NAME }}
          path: release-files/
          retention-days: 7

      - name: æ¸…ç†
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
          echo "========================================="
          
          # æ¢å¤è„šæœ¬
          if [ -f ".github/workflows/scripts/release-GitCode.sh.backup" ]; then
            mv .github/workflows/scripts/release-GitCode.sh.backup .github/workflows/scripts/release-GitCode.sh
            echo "âœ… è„šæœ¬å·²æ¢å¤"
          fi
          
          echo "âœ… æ¸…ç†å®Œæˆ"

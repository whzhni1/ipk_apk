name: æµ‹è¯• Release è„šæœ¬

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼'
        required: true
        type: choice
        options:
          - 'å•ä¸ªå¹³å°æµ‹è¯•'
          - 'æ‰€æœ‰å¹³å°æµ‹è¯•'
        default: 'å•ä¸ªå¹³å°æµ‹è¯•'
      
      single_platform:
        description: 'å•ä¸ªå¹³å°é€‰æ‹© (ä»…å•ä¸ªå¹³å°æµ‹è¯•æ—¶æœ‰æ•ˆ)'
        required: false
        type: choice
        options:
          - 'gitcode'
          - 'gitee'
          - 'gitlab'
        default: 'gitcode'
      
      tag_name:
        description: 'Release æ ‡ç­¾å'
        required: true
        default: 'v1.0.0-test'
      
      release_title:
        description: 'Release æ ‡é¢˜'
        required: true
        default: 'æµ‹è¯• Release'

env:
  # å¹³å°é…ç½®
  GITCODE_REPO: test-release
  GITEE_REPO: test-release
  GITLAB_REPO: test-release
  
  GITCODE_USERNAME: your-gitcode-username
  GITEE_USERNAME: your-gitee-username
  GITLAB_USERNAME: your-gitlab-username
  
  BRANCH: main

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.set-matrix.outputs.platforms }}
    steps:
      - name: è®¾ç½®æµ‹è¯•å¹³å°çŸ©é˜µ
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.test_mode }}" = "å•ä¸ªå¹³å°æµ‹è¯•" ]; then
            echo "platforms=[\"${{ github.event.inputs.single_platform }}\"]" >> $GITHUB_OUTPUT
          else
            echo "platforms=[\"gitcode\",\"gitee\",\"gitlab\"]" >> $GITHUB_OUTPUT
          fi
      
      - name: æ˜¾ç¤ºæµ‹è¯•é…ç½®
        run: |
          echo "### ðŸ§ª æµ‹è¯•é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•æ¨¡å¼**: ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.test_mode }}" = "å•ä¸ªå¹³å°æµ‹è¯•" ]; then
            echo "- **æµ‹è¯•å¹³å°**: ${{ github.event.inputs.single_platform }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **æµ‹è¯•å¹³å°**: GitCode, Gitee, GitLab" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **æ ‡ç­¾åç§°**: ${{ github.event.inputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡é¢˜**: ${{ github.event.inputs.release_title }}" >> $GITHUB_STEP_SUMMARY

  test-release:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.platforms) }}
      fail-fast: false
    
    name: æµ‹è¯• ${{ matrix.platform }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        run: |
          echo "æž„å»ºæ—¶é—´: $(date)" > build-time.txt
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.tag_name }}" > version.txt
          echo "# æµ‹è¯• Release æ–‡ä»¶" > README.md
          echo "æ­¤æ–‡ä»¶ç”¨äºŽæµ‹è¯• Release ä¸Šä¼ åŠŸèƒ½" >> README.md
      
      - name: æµ‹è¯• GitCode Release
        if: matrix.platform == 'gitcode'
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          USERNAME: ${{ env.GITCODE_USERNAME }}
          REPO_NAME: ${{ env.GITCODE_REPO }}
          TAG_NAME: ${{ github.event.inputs.tag_name }}
          RELEASE_TITLE: ${{ github.event.inputs.release_title }}
          RELEASE_BODY: "GitCode æµ‹è¯•"
          UPLOAD_FILES: "build-time.txt version.txt README.md"
        run: |
          chmod +x release-gitcode.sh
          ./release-gitcode.sh
      
      - name: æµ‹è¯• Gitee Release
        if: matrix.platform == 'gitee'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          USERNAME: ${{ env.GITEE_USERNAME }}
          REPO_NAME: ${{ env.GITEE_REPO }}
          TAG_NAME: ${{ github.event.inputs.tag_name }}
          RELEASE_TITLE: ${{ github.event.inputs.release_title }}
          RELEASE_BODY: "Gitee æµ‹è¯•"
          UPLOAD_FILES: "build-time.txt version.txt README.md"
        run: |
          chmod +x release-gitee.sh
          ./release-gitee.sh
      
      - name: æµ‹è¯• GitLab Release
        if: matrix.platform == 'gitlab'
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          USERNAME: ${{ env.GITLAB_USERNAME }}
          REPO_NAME: ${{ env.GITLAB_REPO }}
          TAG_NAME: ${{ github.event.inputs.tag_name }}
          RELEASE_TITLE: ${{ github.event.inputs.release_title }}
          RELEASE_BODY: "GitLab æµ‹è¯•"
          UPLOAD_FILES: "build-time.txt version.txt README.md"
        run: |
          chmod +x release-gitlab.sh
          ./release-gitlab.sh

  summary:
    needs: [prepare, test-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          echo "# ðŸ“Š æµ‹è¯•ç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æµ‹è¯•é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¨¡å¼**: ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ github.event.inputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## å¹³å°çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          
          platforms='${{ needs.prepare.outputs.platforms }}'
          echo "æµ‹è¯•å¹³å°: $platforms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-release.result }}" = "success" ]; then
            echo "âœ… æ‰€æœ‰å¹³å°æµ‹è¯•é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ éƒ¨åˆ†å¹³å°æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi

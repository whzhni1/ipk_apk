name: æ„å»ºopenlist

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º'
        required: false
        type: boolean
        default: false

jobs:
  # ========================================
  # æ£€æŸ¥ç‰ˆæœ¬æ›´æ–°
  # ========================================
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_updates: ${{ steps.set-matrix.outputs.has_updates }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: é…ç½® version-manager.sh
        run: chmod +x .github/workflows/scripts/version-manager.sh

      - name: æ£€æŸ¥é¡¹ç›®æ›´æ–°
        id: check
        run: |
          # é¡¹ç›®é…ç½®ï¼ˆåªæœ‰ openlist2ï¼‰
          PROJECTS='[
            {
              "github_owner": "sbwml",
              "github_repo": "luci-app-openlist2",
              "local_name": "openlist2"
            }
          ]'
          
          UPDATES='[]'
          
          echo "$PROJECTS" | jq -c '.[]' | while read -r project; do
            github_owner=$(echo "$project" | jq -r '.github_owner')
            github_repo=$(echo "$project" | jq -r '.github_repo')
            local_name=$(echo "$project" | jq -r '.local_name')
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "æ£€æŸ¥: ${github_owner}/${github_repo} -> $local_name"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
            latest_tag=$(curl -s "https://api.github.com/repos/${github_owner}/${github_repo}/tags" | jq -r '.[0].name // empty')
            
            if [ -z "$latest_tag" ]; then
              echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šæ¸¸ç‰ˆæœ¬ï¼Œè·³è¿‡"
              continue
            fi
            
            echo "ä¸Šæ¸¸ç‰ˆæœ¬: $latest_tag"
            
            # è·å–æœ¬åœ°è®°å½•çš„ç‰ˆæœ¬
            local_version=$(.github/workflows/scripts/version-manager.sh read "$local_name" || echo "")
            
            if [ -z "$local_version" ]; then
              echo "æœ¬åœ°ç‰ˆæœ¬: æ— è®°å½•"
              echo "âœ… éœ€è¦æ„å»ºï¼ˆæ–°é¡¹ç›®ï¼‰"
              needs_build="true"
            elif [ "$local_version" != "$latest_tag" ]; then
              echo "æœ¬åœ°ç‰ˆæœ¬: $local_version"
              echo "âœ… éœ€è¦æ„å»ºï¼ˆç‰ˆæœ¬ä¸åŒï¼‰"
              needs_build="true"
            else
              echo "æœ¬åœ°ç‰ˆæœ¬: $local_version"
              echo "â„¹ï¸  ç‰ˆæœ¬ç›¸åŒï¼Œè·³è¿‡"
              needs_build="false"
            fi
            
            # å¼ºåˆ¶æ„å»º
            if [ "${{ inputs.force_build }}" = "true" ]; then
              echo "ğŸ”„ å¼ºåˆ¶æ„å»ºæ¨¡å¼"
              needs_build="true"
            fi
            
            if [ "$needs_build" = "true" ]; then
              UPDATES=$(echo "$UPDATES" | jq -c \
                --arg owner "$github_owner" \
                --arg repo "$github_repo" \
                --arg name "$local_name" \
                --arg version "$latest_tag" \
                '. += [{
                  "github_owner": $owner,
                  "github_repo": $repo,
                  "local_name": $name,
                  "version": $version
                }]')
            fi
            
            echo ""
          done
          
          # ä¿å­˜åˆ°æ–‡ä»¶ï¼Œé¿å…ç®¡é“é—®é¢˜
          echo "$UPDATES" > /tmp/updates.json
          cat /tmp/updates.json

      - name: è¯»å–æ›´æ–°åˆ—è¡¨
        id: read-updates
        run: |
          if [ -f /tmp/updates.json ]; then
            UPDATES=$(cat /tmp/updates.json)
          else
            UPDATES='[]'
          fi
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: è®¾ç½®æ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          UPDATES='${{ steps.read-updates.outputs.updates }}'
          
          if [ "$UPDATES" = "[]" ] || [ -z "$UPDATES" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "::notice::æ²¡æœ‰éœ€è¦æ„å»ºçš„é¡¹ç›®"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":$UPDATES}" >> $GITHUB_OUTPUT
            
            echo "éœ€è¦æ„å»ºçš„é¡¹ç›®:"
            echo "$UPDATES" | jq -r '.[] | "  - \(.local_name) (\(.version))"'
          fi

  # ========================================
  # å¹¶è¡Œç¼–è¯‘ï¼ˆä¿ç•™æ‰€æœ‰æ¶æ„ï¼‰
  # ========================================
  build:
    name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - arm_mpcore
          - arm_xscale
          - armeb_xscale
          - i386_pentium-mmx
          - i386_pentium4
          - loongarch64_generic
          - mips64_mips64r2
          - mips64_octeonplus
          - mips64el_mips64r2
          - mips_24kc
          - mips_4kec
          - mips_mips32
          - mipsel_24kc
          - mipsel_24kc_24kf
          - mipsel_74kc
          - mipsel_mips32
          - powerpc_464fp
          - powerpc_8540
          - riscv64_riscv64
          - x86_64
        sdk:
          - openwrt-24.10
          - SNAPSHOT

    steps:
      - name: æ£€å‡ºä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          ref: ${{ matrix.project.version }}
          fetch-depth: 0

      - name: é…ç½®æ„å»ºï¼ˆopenlist2 ä¸“ç”¨ï¼‰
        run: |
          if [ -f "openlist2/Makefile" ]; then
            # é™æ€é“¾æ¥
            sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist2/Makefile
            
            # UPX å‹ç¼©ï¼ˆæ’é™¤ç‰¹å®šæ¶æ„ï¼‰
            if [[ "${{ matrix.arch }}" != loongarch64* ]] && \
               [[ "${{ matrix.arch }}" != mips64* ]] && \
               [[ "${{ matrix.arch }}" != riscv64* ]]; then
              sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile
            fi
          fi

      - name: æ„å»ºè½¯ä»¶åŒ…
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ matrix.project.github_repo }}
          NO_REFRESH_CHECK: true

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
            bin/packages/riscv64_generic/packages_ci/*.apk
            bin/packages/riscv64_generic/packages_ci/*.ipk
          retention-days: 1
          if-no-files-found: warn

  # ========================================
  # æ”¶é›†ç¼–è¯‘äº§ç‰©å¹¶å‘å¸ƒ
  # ========================================
  release:
    name: å‘å¸ƒ ${{ matrix.project.local_name }}
    runs-on: ubuntu-latest
    needs: [check-updates, build]
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½®è„šæœ¬æƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh
          chmod +x .github/workflows/scripts/version-manager.sh

      - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ matrix.project.local_name }}-*
          path: artifacts
          merge-multiple: false

      - name: æ•´ç†æ–‡ä»¶åˆ° release-files ç›®å½•
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ æ•´ç†ç¼–è¯‘æ–‡ä»¶: ${{ matrix.project.local_name }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # åˆ›å»ºç»Ÿä¸€çš„è¾“å‡ºç›®å½•
          mkdir -p release-files
          
          IPK_COUNT=0
          APK_COUNT=0
          
          # éå†æ‰€æœ‰ä¸‹è½½çš„ artifact
          for artifact_dir in artifacts/${{ matrix.project.local_name }}-*/; do
            if [ ! -d "$artifact_dir" ]; then
              continue
            fi
            
            artifact_name=$(basename "$artifact_dir")
            echo "å¤„ç†: $artifact_name"
            
            # å¤åˆ¶ IPK æ–‡ä»¶
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                
                # é¿å…é‡å¤å¤åˆ¶ _all.ipk
                if [[ "$filename" == *"_all.ipk" ]] && [ -f "release-files/$filename" ]; then
                  echo "  è·³è¿‡: $filename (å·²å­˜åœ¨)"
                else
                  cp "$file" release-files/
                  echo "  âœ… IPK: $filename"
                  IPK_COUNT=$((IPK_COUNT + 1))
                fi
              fi
            done < <(find "$artifact_dir" -type f -name "*.ipk" 2>/dev/null)
            
            # å¤åˆ¶ APK æ–‡ä»¶
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                
                # luci-app å’Œ luci-i18n æ˜¯æ¶æ„æ— å…³çš„ï¼Œé¿å…é‡å¤
                if [[ "$filename" == luci-* ]]; then
                  if [ -f "release-files/$filename" ]; then
                    echo "  è·³è¿‡: $filename (å·²å­˜åœ¨)"
                    continue
                  fi
                fi
                
                cp "$file" release-files/
                echo "  âœ… APK: $filename"
                APK_COUNT=$((APK_COUNT + 1))
              fi
            done < <(find "$artifact_dir" -type f -name "*.apk" 2>/dev/null)
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "IPK: $IPK_COUNT ä¸ª"
          echo "APK: $APK_COUNT ä¸ª"
          echo "æ€»è®¡: $((IPK_COUNT + APK_COUNT)) ä¸ª"
          echo ""
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œä¼ é€’ç»™è„šæœ¬ï¼‰
          find release-files -type f \( -name "*.ipk" -o -name "*.apk" \) | sort

      - name: ğŸš€ å¹¶è¡Œå‘å¸ƒåˆ° GitCode å’Œ Gitee
        env:
          # GitCode é…ç½®
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_USERNAME: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
          
          # Gitee é…ç½®
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
          
          # å…±åŒå‚æ•°
          REPO_NAME: ${{ matrix.project.local_name }}
          TAG_NAME: ${{ matrix.project.version }}
          RELEASE_TITLE: "${{ matrix.project.local_name }} ${{ matrix.project.version }}"
          RELEASE_BODY: |
            ## ğŸ“¦ ${{ matrix.project.local_name }} ${{ matrix.project.version }}
            
            ### ğŸ“Œ é¡¹ç›®ä¿¡æ¯
            - é¡¹ç›®åç§°: ${{ matrix.project.github_repo }}
            - é¡¹ç›®ç‰ˆæœ¬: ${{ matrix.project.version }}
            - ä¸Šæ¸¸ä»“åº“: https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
            - ä¸Šæ¸¸åœ°å€: https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}/releases/tag/${{ matrix.project.version }}
            
            ### ğŸ”¨ æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
            - å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - æ¶æ„æ•°é‡: 33 ä¸ª
            - SDK ç‰ˆæœ¬: OpenWrt 24.10 + SNAPSHOT
        run: |
          # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰
          UPLOAD_FILES=$(find release-files -type f \( -name "*.ipk" -o -name "*.apk" \) | tr '\n' ' ')
          
          echo "å‡†å¤‡å‘å¸ƒæ–‡ä»¶æ•°é‡: $(echo $UPLOAD_FILES | wc -w)"
          
          # å¹¶è¡Œå‘å¸ƒåˆ°ä¸¤ä¸ªå¹³å°
          (
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ å‘å¸ƒåˆ° GitCode"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            GITCODE_TOKEN="$GITCODE_TOKEN" \
            USERNAME="$GITCODE_USERNAME" \
            REPO_NAME="$REPO_NAME" \
            TAG_NAME="$TAG_NAME" \
            RELEASE_TITLE="$RELEASE_TITLE" \
            RELEASE_BODY="$RELEASE_BODY" \
            UPLOAD_FILES="$UPLOAD_FILES" \
            .github/workflows/scripts/release-GitCode.sh
          ) &
          
          (
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ å‘å¸ƒåˆ° Gitee"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            GITEE_TOKEN="$GITEE_TOKEN" \
            USERNAME="$GITEE_USERNAME" \
            REPO_NAME="$REPO_NAME" \
            TAG_NAME="$TAG_NAME" \
            RELEASE_TITLE="$RELEASE_TITLE" \
            RELEASE_BODY="$RELEASE_BODY" \
            UPLOAD_FILES="$UPLOAD_FILES" \
            .github/workflows/scripts/release-gitee.sh
          ) &
          
          # ç­‰å¾…ä¸¤ä¸ªè¿›ç¨‹éƒ½å®Œæˆ
          wait
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… å¹¶è¡Œå‘å¸ƒå®Œæˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•åˆ° version.txt
        run: |
          # å†™å…¥ç‰ˆæœ¬è®°å½•
          .github/workflows/scripts/version-manager.sh write \
            "${{ matrix.project.local_name }}" \
            "${{ matrix.project.version }}"
          
          # æäº¤åˆ°ä»“åº“
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add version.txt
          
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ“ æ›´æ–°ç‰ˆæœ¬è®°å½•: ${{ matrix.project.local_name }} -> ${{ matrix.project.version }}"
            git pull --rebase
            git push
          else
            echo "â„¹ï¸  ç‰ˆæœ¬è®°å½•æ— å˜åŒ–"
          fi

  # ========================================
  # ç”ŸæˆæŠ¥å‘Š
  # ========================================
  report:
    runs-on: ubuntu-latest
    needs: [check-updates, build, release]
    if: always()
    
    steps:
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          HAS_UPDATES="${{ needs.check-updates.outputs.has_updates }}"
          BUILD_STATUS="${{ needs.build.result }}"
          RELEASE_STATUS="${{ needs.release.result }}"
          
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ“¦ OpenWrt è½¯ä»¶åŒ…æ„å»ºæŠ¥å‘Š
          
          **è§¦å‘æ—¶é—´**: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (åŒ—äº¬æ—¶é—´)  
          **å¼ºåˆ¶æ„å»º**: ${{ inputs.force_build }}
          
          ---
          
          ## ğŸ“Š ä»»åŠ¡çŠ¶æ€
          
          | é˜¶æ®µ | çŠ¶æ€ |
          |------|------|
          | ç‰ˆæœ¬æ£€æŸ¥ | $([ "$HAS_UPDATES" = "true" ] && echo "âœ… å‘ç°æ›´æ–°" || echo "â„¹ï¸  æ— æ›´æ–°") |
          | è½¯ä»¶åŒ…æ„å»º | $([ "$BUILD_STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || [ "$BUILD_STATUS" = "skipped" ] && echo "â­ï¸ è·³è¿‡" || echo "âŒ å¤±è´¥") |
          | æ–‡ä»¶å‘å¸ƒ | $([ "$RELEASE_STATUS" = "success" ] && echo "âœ… æˆåŠŸ" || [ "$RELEASE_STATUS" = "skipped" ] && echo "â­ï¸ è·³è¿‡" || echo "âŒ å¤±è´¥") |
          
          ---
          
          ## ğŸ“‹ é¡¹ç›®åˆ—è¡¨
          
          ```json
          ${{ needs.check-updates.outputs.matrix }}
          ```
          
          ---
          
          ## ğŸ”— å‘å¸ƒå¹³å°
          
          - ğŸŒ GitCode
          - ğŸŒ Gitee
          
          EOF
          
          if [ "$HAS_UPDATES" = "true" ] && [ "$RELEASE_STATUS" = "success" ]; then
            echo "::notice title=å‘å¸ƒæˆåŠŸ::è½¯ä»¶åŒ…å·²æˆåŠŸå‘å¸ƒåˆ° GitCode å’Œ Gitee"
          elif [ "$HAS_UPDATES" = "false" ]; then
            echo "::notice title=æ— éœ€æ›´æ–°::å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          else
            echo "::error title=å‘å¸ƒå¤±è´¥::æ„å»ºæˆ–å‘å¸ƒè¿‡ç¨‹å‡ºç°é”™è¯¯"
          fi

name: æ„å»ºopenlist

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º'
        required: false
        type: boolean
        default: false

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_updates: ${{ steps.set-matrix.outputs.has_updates }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: é…ç½® version-manager.sh
        run: chmod +x .github/workflows/scripts/version-manager.sh

      - name: æ£€æŸ¥é¡¹ç›®æ›´æ–°
        id: check
        run: |
          PROJECTS='[
            {
              "github_owner": "sbwml",
              "github_repo": "luci-app-openlist2",
              "local_name": "openlist"
            }
          ]'
          
          UPDATES='[]'
          
          while read -r project; do
            github_owner=$(echo "$project" | jq -r '.github_owner')
            github_repo=$(echo "$project" | jq -r '.github_repo')
            local_name=$(echo "$project" | jq -r '.local_name')
            
            echo "æ£€æŸ¥: ${github_owner}/${github_repo} -> $local_name"
            
            latest_tag=$(curl -s "https://api.github.com/repos/${github_owner}/${github_repo}/tags" | jq -r '.[0].name // empty')
            
            if [ -z "$latest_tag" ]; then
              echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šæ¸¸ç‰ˆæœ¬ï¼Œè·³è¿‡"
              continue
            fi
            
            echo "ä¸Šæ¸¸ç‰ˆæœ¬: $latest_tag"
            
            local_version=$(.github/workflows/scripts/version-manager.sh read "$local_name" 2>/dev/null || echo "")
            
            if [ -z "$local_version" ]; then
              echo "æœ¬åœ°ç‰ˆæœ¬: æ— è®°å½•"
              echo "âœ… éœ€è¦æ„å»ºï¼ˆæ–°é¡¹ç›®ï¼‰"
              needs_build="true"
            elif [ "$local_version" != "$latest_tag" ]; then
              echo "æœ¬åœ°ç‰ˆæœ¬: $local_version"
              echo "âœ… éœ€è¦æ„å»ºï¼ˆç‰ˆæœ¬ä¸åŒï¼‰"
              needs_build="true"
            else
              echo "æœ¬åœ°ç‰ˆæœ¬: $local_version"
              echo "â„¹ï¸  ç‰ˆæœ¬ç›¸åŒï¼Œè·³è¿‡"
              needs_build="false"
            fi
            
            if [ "${{ inputs.force_build }}" = "true" ]; then
              echo "ğŸ”„ å¼ºåˆ¶æ„å»ºæ¨¡å¼"
              needs_build="true"
            fi
            
            if [ "$needs_build" = "true" ]; then
              echo "ğŸ“ æ·»åŠ åˆ°æ„å»ºåˆ—è¡¨"
              UPDATES=$(echo "$UPDATES" | jq -c \
                --arg owner "$github_owner" \
                --arg repo "$github_repo" \
                --arg name "$local_name" \
                --arg version "$latest_tag" \
                '. += [{
                  "github_owner": $owner,
                  "github_repo": $repo,
                  "local_name": $name,
                  "version": $version
                }]')
              
              echo "å½“å‰ UPDATES: $UPDATES"
            fi
            
            echo ""
          done < <(echo "$PROJECTS" | jq -c '.[]')
          
          echo "æœ€ç»ˆæ„å»ºåˆ—è¡¨:"
          echo "$UPDATES" | jq '.'
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: è®¾ç½®æ„å»ºçŸ©é˜µ
        id: set-matrix
        run: |
          UPDATES='${{ steps.check.outputs.updates }}'
          
          echo "æ¥æ”¶åˆ°çš„ UPDATES:"
          echo "$UPDATES"
          echo ""
          
          if [ "$UPDATES" = "[]" ] || [ -z "$UPDATES" ] || [ "$UPDATES" = "null" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "::notice::æ²¡æœ‰éœ€è¦æ„å»ºçš„é¡¹ç›®"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":$UPDATES}" >> $GITHUB_OUTPUT
            
            echo "éœ€è¦æ„å»ºçš„é¡¹ç›®:"
            echo "$UPDATES" | jq -r '.[] | "  - \(.local_name) (\(.version))"'
          fi

  build:
    name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - x86_64
        sdk:
          - openwrt-24.10
          - SNAPSHOT

    steps:
      - name: æ£€å‡ºä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          ref: ${{ matrix.project.version }}
          fetch-depth: 0

      - name: é…ç½®æ„å»ºï¼ˆopenlist2 ä¸“ç”¨ï¼‰
        run: |
          if [ -f "openlist2/Makefile" ]; then
            sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist2/Makefile
            
            if [[ "${{ matrix.arch }}" != loongarch64* ]] && \
               [[ "${{ matrix.arch }}" != mips64* ]] && \
               [[ "${{ matrix.arch }}" != riscv64* ]]; then
              sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile
            fi
          fi

      - name: æ„å»ºè½¯ä»¶åŒ…
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ matrix.project.github_repo }}
          NO_REFRESH_CHECK: true

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
            bin/packages/riscv64_generic/packages_ci/*.apk
            bin/packages/riscv64_generic/packages_ci/*.ipk
          retention-days: 1
          if-no-files-found: warn

  release:
    name: å‘å¸ƒ ${{ matrix.project.local_name }}
    runs-on: ubuntu-latest
    needs: [check-updates, build]
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: é…ç½® version-manager.sh
        run: chmod +x .github/workflows/scripts/version-manager.sh

      - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: /tmp/artifacts-download
          pattern: ${{ matrix.project.local_name }}-*
          merge-multiple: true

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        id: organize
        run: |
          PROJECT="${{ matrix.project.local_name }}"
          VERSION="${{ matrix.project.version }}"
          
          RELEASE_DIR="/tmp/release-$PROJECT-$VERSION"
          mkdir -p "$RELEASE_DIR"
          
          echo "æ•´ç†æ–‡ä»¶åˆ°: $RELEASE_DIR"
          
          find /tmp/artifacts-download -type f \( -name "*.apk" -o -name "*.ipk" \) -exec mv {} "$RELEASE_DIR/" \;
          
          FILE_COUNT=$(ls -1 "$RELEASE_DIR" 2>/dev/null | wc -l)
          echo "å…±æ•´ç† $FILE_COUNT ä¸ªæ–‡ä»¶"
          
          if [ $FILE_COUNT -eq 0 ]; then
            echo "::error::æœªæ‰¾åˆ°ä»»ä½•ç¼–è¯‘äº§ç‰©"
            exit 1
          fi
          
          ls -lh "$RELEASE_DIR"
          
          echo "release_dir=$RELEASE_DIR" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆ° GitHub Release
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.project.local_name }}-${{ matrix.project.version }}
          name: ${{ matrix.project.local_name }} ${{ matrix.project.version }}
          body: |
            ## ğŸ“¦ ${{ matrix.project.local_name }} ${{ matrix.project.version }}
            
            **ä¸Šæ¸¸ä»“åº“**: [${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}](https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }})
            **ç¼–è¯‘æ—¶é—´**: ${{ env.BUILD_TIME }}
            **æ–‡ä»¶æ•°é‡**: ${{ steps.organize.outputs.file_count }}
            
            ### ğŸ“¥ å®‰è£…æ–¹æ³•
            ```bash
            opkg install <package-file>.ipk
            ```
          files: ${{ steps.organize.outputs.release_dir }}/*
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          BUILD_TIME: ${{ github.event.repository.updated_at }}

      - name: æ›´æ–°ç‰ˆæœ¬è®°å½•
        if: success()
        run: |
          .github/workflows/scripts/version-manager.sh write \
            "${{ matrix.project.local_name }}" \
            "${{ matrix.project.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions.json
          git diff-index --quiet HEAD || git commit -m "chore: æ›´æ–° ${{ matrix.project.local_name }} åˆ° ${{ matrix.project.version }}"
          git push

  report:
    name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [check-updates, build, release]
    if: always() && needs.check-updates.outputs.has_updates == 'true'
    
    steps:
      - name: ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ¯ æ„å»ºæŠ¥å‘Š
          
          ## ğŸ“Š æ‰§è¡ŒçŠ¶æ€
          
          | é˜¶æ®µ | çŠ¶æ€ |
          |------|------|
          | ç‰ˆæœ¬æ£€æŸ¥ | ${{ needs.check-updates.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | è½¯ä»¶åŒ…æ„å»º | ${{ needs.build.result == 'success' && 'âœ… æˆåŠŸ' || needs.build.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |
          | æ–‡ä»¶å‘å¸ƒ | ${{ needs.release.result == 'success' && 'âœ… æˆåŠŸ' || needs.release.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥' }} |
          
          ## ğŸ“‹ é¡¹ç›®åˆ—è¡¨
          
          ```json
          ${{ needs.check-updates.outputs.matrix }}
          ```
          
          ## âš™ï¸ æ„å»ºé…ç½®
          
          - **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'workflow_dispatch' && 'æ‰‹åŠ¨è§¦å‘' || 'è‡ªåŠ¨è§¦å‘' }}
          - **å¼ºåˆ¶æ„å»º**: ${{ inputs.force_build == true && 'æ˜¯' || 'å¦' }}
          - **å·¥ä½œæµ**: `${{ github.workflow }}`
          - **è¿è¡Œ ID**: `${{ github.run_id }}`
          
          ---
          
          *æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${{ github.event.repository.updated_at }}*
          EOF

  cleanup:
    name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    
    steps:
      - name: åˆ é™¤ä¸´æ—¶ Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            openlist-*
          failOnError: false

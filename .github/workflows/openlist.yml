name: ÊûÑÂª∫ OpenList

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Âº∫Âà∂ÈáçÊñ∞ÊûÑÂª∫'
        type: boolean
        default: false

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.value }}
      has_updates: ${{ steps.matrix.outputs.has_updates }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Ê£ÄÊü•Êõ¥Êñ∞
        id: matrix
        run: |
          chmod +x .github/workflows/scripts/version-manager.sh
          
          PROJECTS='[{"github_owner":"sbwml","github_repo":"luci-app-openlist2","local_name":"openlist2"}]'
          UPDATES='[]'
          
          while read -r proj; do
            owner=$(echo "$proj" | jq -r '.github_owner')
            repo=$(echo "$proj" | jq -r '.github_repo')
            name=$(echo "$proj" | jq -r '.local_name')
            
            latest=$(curl -s "https://api.github.com/repos/$owner/$repo/tags" | jq -r '.[0].name // empty')
            [ -z "$latest" ] && { echo "‚ö†Ô∏è  $name: Êó†‰∏äÊ∏∏ÁâàÊú¨"; continue; }
            
            local=$(.github/workflows/scripts/version-manager.sh read "$name" 2>/dev/null || echo "")
            
            if [ -z "$local" ] || [ "$local" != "$latest" ] || [ "${{ inputs.force_build }}" = "true" ]; then
              echo "‚úÖ $name: ${local:-Êñ∞È°πÁõÆ} ‚Üí $latest"
              UPDATES=$(echo "$UPDATES" | jq -c \
                --arg o "$owner" --arg r "$repo" --arg n "$name" --arg v "$latest" \
                '. += [{github_owner:$o, github_repo:$r, local_name:$n, version:$v}]')
            else
              echo "‚ÑπÔ∏è  $name: Â∑≤ÊòØÊúÄÊñ∞ ($latest)"
            fi
          done < <(echo "$PROJECTS" | jq -c '.[]')
          
          if [ "$UPDATES" = "[]" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "value={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "::notice::Êó†ÈúÄÊûÑÂª∫"
          else
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "value={\"include\":$UPDATES}" >> $GITHUB_OUTPUT
          fi

  build:
    name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
        arch: [aarch64_cortex-a53, aarch64_cortex-a72, aarch64_cortex-a76, aarch64_generic, arm_cortex-a15_neon-vfpv4, arm_cortex-a5_vfpv4, arm_cortex-a7, arm_cortex-a7_neon-vfpv4, arm_cortex-a7_vfpv4, arm_cortex-a8_vfpv3, arm_cortex-a9, arm_cortex-a9_neon, arm_cortex-a9_vfpv3-d16, x86_64]
        sdk: [openwrt-24.10, SNAPSHOT]

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          ref: ${{ matrix.project.version }}
          fetch-depth: 0

      - name: ÈÖçÁΩÆÊûÑÂª∫
        run: |
          [ ! -f "openlist2/Makefile" ] && exit 0
          sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:=-w -s -extldflags "-static"' openlist2/Makefile
          [[ "${{ matrix.arch }}" != loongarch64* && "${{ matrix.arch }}" != mips64* && "${{ matrix.arch }}" != riscv64* ]] && \
            sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile

      - name: ÊûÑÂª∫ËΩØ‰ª∂ÂåÖ
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ matrix.project.github_repo }}
          NO_REFRESH_CHECK: true

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
          retention-days: 1
          if-no-files-found: warn

  release:
    name: ÂèëÂ∏É ${{ matrix.project.local_name }}
    runs-on: ubuntu-latest
    needs: [check-updates, build]
    if: needs.check-updates.outputs.has_updates == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ÈÖçÁΩÆËÑöÊú¨
        run: chmod +x .github/workflows/scripts/{release-*.sh,version-manager.sh}

      - uses: actions/download-artifact@v4
        with:
          pattern: ${{ matrix.project.local_name }}-*
          path: ${{ runner.temp }}/artifacts
          merge-multiple: false

      - name: Êï¥ÁêÜÊñá‰ª∂
        run: |
          RELEASE_DIR="${{ runner.temp }}/release"
          mkdir -p "$RELEASE_DIR"
          
          find "${{ runner.temp }}/artifacts" -name "${{ matrix.project.local_name }}-*" -type d | while read -r dir; do
            arch=$(basename "$dir" | sed 's/^${{ matrix.project.local_name }}-//' | sed 's/-\(openwrt-24.10\|SNAPSHOT\)$//')
            
            # IPK (_all.ipk ÂéªÈáç)
            find "$dir" -name "*.ipk" | while read -r f; do
              name=$(basename "$f")
              [[ "$name" == *_all.ipk ]] && [ -f "$RELEASE_DIR/$name" ] && continue
              cp "$f" "$RELEASE_DIR/"
            done
            
            # APK (luci-* ÈÄöÁî®ÔºåÂÖ∂‰ªñÂä†Êû∂ÊûÑ)
            find "$dir" -name "*.apk" | while read -r f; do
              name=$(basename "$f")
              if [[ "$name" == luci-* ]]; then
                [ -f "$RELEASE_DIR/$name" ] || cp "$f" "$RELEASE_DIR/"
              else
                cp "$f" "$RELEASE_DIR/${name%.apk}_${arch}.apk"
              fi
            done
          done
          
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV
          echo "Êñá‰ª∂ÁªüËÆ°: $(find "$RELEASE_DIR" -type f 2>/dev/null | wc -l) ‰∏™"

      - name: Âπ∂Ë°åÂèëÂ∏É
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITCODE_USERNAME: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_USERNAME: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_USERNAME: ${{ secrets.GITLAB_USERNAME || 'whzhni' }}
          REPO_NAME: ${{ matrix.project.local_name }}
          TAG_NAME: ${{ matrix.project.version }}
          RELEASE_TITLE: "${{ matrix.project.local_name }} ${{ matrix.project.version }}"
          RELEASE_DIR: ${{ env.RELEASE_DIR }}
        run: |
          export UPLOAD_FILES="$(find "$RELEASE_DIR" -type f \( -name '*.ipk' -o -name '*.apk' \) 2>/dev/null | tr '\n' ' ')"
          export RELEASE_BODY="## üì¶ ${{ matrix.project.local_name }} ${{ matrix.project.version }}

          ### üìå È°πÁõÆ‰ø°ÊÅØ
          - ‰∏äÊ∏∏‰ªìÂ∫ì: https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          - ÊûÑÂª∫Êó∂Èó¥: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (Âåó‰∫¨Êó∂Èó¥)
          - SDK ÁâàÊú¨: OpenWrt 24.10 + SNAPSHOT"
          export RUNNER_TEMP="${{ runner.temp }}"
          export BRANCH="main"
          
          echo "üì¶ ÂáÜÂ§áÂèëÂ∏É $(echo $UPLOAD_FILES | wc -w) ‰∏™Êñá‰ª∂"
          
          declare -A PIDS RESULTS
          
          [ -n "$GITCODE_TOKEN" ] && {
            (
              export USERNAME="$GITCODE_USERNAME"
              export GITCODE_TOKEN="$GITCODE_TOKEN"
              export REPO_NAME="$REPO_NAME"
              export TAG_NAME="$TAG_NAME"
              export RELEASE_TITLE="$RELEASE_TITLE"
              .github/workflows/scripts/release-gitcode.sh
            ) &
            PIDS[gitcode]=$!
          }
          
          [ -n "$GITEE_TOKEN" ] && {
            (
              export USERNAME="$GITEE_USERNAME"
              export GITEE_TOKEN="$GITEE_TOKEN"
              export REPO_NAME="$REPO_NAME"
              export TAG_NAME="$TAG_NAME"
              export RELEASE_TITLE="$RELEASE_TITLE"
              .github/workflows/scripts/release-gitee.sh
            ) &
            PIDS[gitee]=$!
          }
          
          [ -n "$GITLAB_TOKEN" ] && {
            (
              export USERNAME="$GITLAB_USERNAME"
              export GITLAB_TOKEN="$GITLAB_TOKEN"
              export REPO_NAME="$REPO_NAME"
              export TAG_NAME="$TAG_NAME"
              export RELEASE_TITLE="$RELEASE_TITLE"
              .github/workflows/scripts/release-gitlab.sh
            ) &
            PIDS[gitlab]=$!
          }
          
          for platform in "${!PIDS[@]}"; do
            wait ${PIDS[$platform]}
            RESULTS[$platform]=$?
            echo "$platform: $([ "${RESULTS[$platform]}" = "0" ] && echo '‚úÖ' || echo '‚ùå')"
          done
          
          for status in "${RESULTS[@]}"; do
            [ "$status" = "0" ] && exit 0
          done
          echo "::error::ÊâÄÊúâÂπ≥Âè∞ÈÉΩÂèëÂ∏ÉÂ§±Ë¥•"; exit 1

      - name: Êõ¥Êñ∞ÁâàÊú¨ËÆ∞ÂΩï
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          .github/workflows/scripts/version-manager.sh write "${{ matrix.project.local_name }}" "${{ matrix.project.version }}"
          git add version.txt
          git diff --cached --quiet || {
            git commit -m "üìù ${{ matrix.project.local_name }} ‚Üí ${{ matrix.project.version }}"
            git pull --rebase origin ${{ github.ref_name }} || git push --force-with-lease
            git push origin ${{ github.ref_name }}
          }

name: æ„å»ºopenlist

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º'
        required: false
        type: boolean
        default: false

jobs:
                                                                                                                         
  # æ£€æŸ¥ç‰ˆæœ¬æ›´æ–°
                                                                                                                         
 check-updates:
  runs-on: ubuntu-latest
  outputs:
    matrix: ${{ steps.set-matrix.outputs.matrix }}
    has_updates: ${{ steps.set-matrix.outputs.has_updates }}
  
  steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: é…ç½® version-manager.sh
      run: chmod +x .github/workflows/scripts/version-manager.sh

    - name: æ£€æŸ¥é¡¹ç›®æ›´æ–°
      id: check
      run: |
        # é¡¹ç›®é…ç½®ï¼ˆåªæœ‰ openlist2ï¼‰
        PROJECTS   '[
          {
            "github_owner": "sbwml",
            "github_repo": "luci-app-openlist2",
            "local_name": "openlist"
          }
        ]'
        
        UPDATES   '[]'
        
        # ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨è¿›ç¨‹æ›¿æ¢è€Œä¸æ˜¯ç®¡é“
        while read -r project; do
          github_owner   $(echo "$project" | jq -r '.github_owner')
          github_repo   $(echo "$project" | jq -r '.github_repo')
          local_name   $(echo "$project" | jq -r '.local_name')
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "æ£€æŸ¥: ${github_owner}/${github_repo} -> $local_name"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
          latest_tag   $(curl -s "https://api.github.com/repos/${github_owner}/${github_repo}/tags" | jq -r '.[0].name // empty')
          
          if [ -z "$latest_tag" ]; then
            echo "âš ï¸  æœªæ‰¾åˆ°ä¸Šæ¸¸ç‰ˆæœ¬ï¼Œè·³è¿‡"
            continue
          fi
          
          echo "ä¸Šæ¸¸ç‰ˆæœ¬: $latest_tag"
          
          # è·å–æœ¬åœ°è®°å½•çš„ç‰ˆæœ¬
          local_version   $(.github/workflows/scripts/version-manager.sh read "$local_name" 2>/dev/null || echo "")
          
          if [ -z "$local_version" ]; then
            echo "æœ¬åœ°ç‰ˆæœ¬: æ— è®°å½•"
            echo "âœ… éœ€è¦æ„å»ºï¼ˆæ–°é¡¹ç›®ï¼‰"
            needs_build   "true"
          elif [ "$local_version" !    "$latest_tag" ]; then
            echo "æœ¬åœ°ç‰ˆæœ¬: $local_version"
            echo "âœ… éœ€è¦æ„å»ºï¼ˆç‰ˆæœ¬ä¸åŒï¼‰"
            needs_build   "true"
          else
            echo "æœ¬åœ°ç‰ˆæœ¬: $local_version"
            echo "â„¹ï¸  ç‰ˆæœ¬ç›¸åŒï¼Œè·³è¿‡"
            needs_build   "false"
          fi
          
          # å¼ºåˆ¶æ„å»º
          if [ "${{ inputs.force_build }}"     "true" ]; then
            echo "ğŸ”„ å¼ºåˆ¶æ„å»ºæ¨¡å¼"
            needs_build   "true"
          fi
          
          if [ "$needs_build"     "true" ]; then
            echo "ğŸ“ æ·»åŠ åˆ°æ„å»ºåˆ—è¡¨"
            UPDATES   $(echo "$UPDATES" | jq -c \
              --arg owner "$github_owner" \
              --arg repo "$github_repo" \
              --arg name "$local_name" \
              --arg version "$latest_tag" \
              '. +    [{
                "github_owner": $owner,
                "github_repo": $repo,
                "local_name": $name,
                "version": $version
              }]')
            
            # è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰ UPDATES
            echo "å½“å‰ UPDATES: $UPDATES"
          fi
          
          echo ""
        done < <(echo "$PROJECTS" | jq -c '.[]')
        
        # è¾“å‡ºæœ€ç»ˆç»“æœ
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "æœ€ç»ˆæ„å»ºåˆ—è¡¨:"
        echo "$UPDATES" | jq '.'
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # è¾“å‡ºåˆ° GitHub Actions
        echo "updates   $UPDATES" >> $GITHUB_OUTPUT
    - name: è®¾ç½®æ„å»ºçŸ©é˜µ
      id: set-matrix
      run: |
        UPDATES   '${{ steps.check.outputs.updates }}'
        
        echo "æ¥æ”¶åˆ°çš„ UPDATES:"
        echo "$UPDATES"
        echo ""
        
        if [ "$UPDATES"     "[]" ] || [ -z "$UPDATES" ] || [ "$UPDATES"     "null" ]; then
          echo "has_updates   false" >> $GITHUB_OUTPUT
          echo "matrix   {\"include\":[]}" >> $GITHUB_OUTPUT
          echo "::notice::æ²¡æœ‰éœ€è¦æ„å»ºçš„é¡¹ç›®"
        else
          echo "has_updates   true" >> $GITHUB_OUTPUT
          echo "matrix   {\"include\":$UPDATES}" >> $GITHUB_OUTPUT
          
          echo "éœ€è¦æ„å»ºçš„é¡¹ç›®:"
          echo "$UPDATES" | jq -r '.[] | "  - \(.local_name) (\(.version))"'
        fi
                                                                                                                         
  # å¹¶è¡Œç¼–è¯‘ï¼ˆä¿ç•™æ‰€æœ‰æ¶æ„ï¼‰
                                                                                                                         
 build:
    name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates        'true'
    
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
        arch:
          - aarch64_cortex-a53
          - aarch64_cortex-a72
          - aarch64_cortex-a76
          - aarch64_generic
          - arm_cortex-a15_neon-vfpv4
          - arm_cortex-a5_vfpv4
          - arm_cortex-a7
          - arm_cortex-a7_neon-vfpv4
          - arm_cortex-a7_vfpv4
          - arm_cortex-a8_vfpv3
          - arm_cortex-a9
          - arm_cortex-a9_neon
          - arm_cortex-a9_vfpv3-d16
          - x86_64
        sdk:
          - openwrt-24.10
          - SNAPSHOT

    steps:
      - name: æ£€å‡ºä¸Šæ¸¸ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
          ref: ${{ matrix.project.version }}
          fetch-depth: 0

      - name: é…ç½®æ„å»ºï¼ˆopenlist2 ä¸“ç”¨ï¼‰
        run: |
          if [ -f "openlist2/Makefile" ]; then
            # é™æ€é“¾æ¥
            sed -i '/golang-package/a \\tGO_PKG_DEFAULT_LDFLAGS:   -w -s -extldflags "-static"' openlist2/Makefile
            
            # UPX å‹ç¼©ï¼ˆæ’é™¤ç‰¹å®šæ¶æ„ï¼‰
            if [[ "${{ matrix.arch }}" !    loongarch64* ]] && \
               [[ "${{ matrix.arch }}" !    mips64* ]] && \
               [[ "${{ matrix.arch }}" !    riscv64* ]]; then
              sed -i '/openlist2.init/a \\t/usr/bin/upx --lzma --best $(1)\/usr\/bin\/openlist2' openlist2/Makefile
            fi
          fi
      - name: æ„å»ºè½¯ä»¶åŒ…
        uses: sbwml/openwrt-gh-action-sdk@go1.25
        env:
          ARCH: ${{ matrix.arch }}-${{ matrix.sdk }}
          FEEDNAME: packages_ci
          PACKAGES: ${{ matrix.project.github_repo }}
          NO_REFRESH_CHECK: true

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.local_name }}-${{ matrix.arch }}-${{ matrix.sdk }}
          path: |
            bin/packages/${{ matrix.arch }}/packages_ci/*.apk
            bin/packages/${{ matrix.arch }}/packages_ci/*.ipk
            bin/packages/riscv64_generic/packages_ci/*.apk
            bin/packages/riscv64_generic/packages_ci/*.ipk
          retention-days: 1
          if-no-files-found: warn

                                                                                                                         
  # æ”¶é›†ç¼–è¯‘äº§ç‰©å¹¶å‘å¸ƒ
 release:
  name: å‘å¸ƒ ${{ matrix.project.local_name }}
  runs-on: ubuntu-latest
  needs: [check-updates, build]
  if: needs.check-updates.outputs.has_updates == 'true'
  
  strategy:
    fail-fast: false
    matrix:
      project: ${{ fromJson(needs.check-updates.outputs.matrix).include }}
  
  steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: é…ç½®è„šæœ¬æƒé™
      run: |
        chmod +x .github/workflows/scripts/release-GitCode.sh
        chmod +x .github/workflows/scripts/release-gitee.sh
        chmod +x .github/workflows/scripts/version-manager.sh

    # ğŸ”§ ä¿®å¤ï¼šä¸‹è½½åˆ°ä¸´æ—¶ç›®å½•ï¼Œä¸åœ¨ä»“åº“ç›®å½•
    - name: ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        pattern: ${{ matrix.project.local_name }}-*
        path: ${{ runner.temp }}/artifacts  # âœ… ä½¿ç”¨ Runner ä¸´æ—¶ç›®å½•
        merge-multiple: false

    # ğŸ”§ ä¿®å¤ï¼šåœ¨ä¸´æ—¶ç›®å½•æ•´ç†æ–‡ä»¶
    - name: æ•´ç†æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ æ•´ç†ç¼–è¯‘æ–‡ä»¶: ${{ matrix.project.local_name }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # âœ… ä½¿ç”¨ Runner ä¸´æ—¶ç›®å½•
        ARTIFACTS_DIR="${{ runner.temp }}/artifacts"
        RELEASE_DIR="${{ runner.temp }}/release-files"
        
        mkdir -p "$RELEASE_DIR"
        
        echo "å·¥ä»¶ç›®å½•: $ARTIFACTS_DIR"
        echo "å‘å¸ƒç›®å½•: $RELEASE_DIR"
        echo ""
        
        IPK_COUNT=0
        APK_COUNT=0
        
        for artifact_dir in "$ARTIFACTS_DIR"/${{ matrix.project.local_name }}-*/; do
          if [ ! -d "$artifact_dir" ]; then
            continue
          fi
          
          artifact_name=$(basename "$artifact_dir")
          arch=$(echo "$artifact_name" | sed 's/^${{ matrix.project.local_name }}-//' | sed 's/-openwrt-24.10$//' | sed 's/-SNAPSHOT$//')
          
          echo "å¤„ç†: $artifact_name (æ¶æ„: $arch)"
          
          # å¤„ç† IPK æ–‡ä»¶
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              
              if [[ "$filename" == *"_all.ipk" ]]; then
                if [ -f "$RELEASE_DIR/$filename" ]; then
                  echo "  â­ï¸  IPK (è·³è¿‡): $filename"
                else
                  cp "$file" "$RELEASE_DIR/"
                  echo "  âœ… IPK: $filename"
                  IPK_COUNT=$((IPK_COUNT + 1))
                fi
              else
                cp "$file" "$RELEASE_DIR/"
                echo "  âœ… IPK: $filename"
                IPK_COUNT=$((IPK_COUNT + 1))
              fi
            fi
          done < <(find "$artifact_dir" -type f -name "*.ipk" 2>/dev/null)
          
          # å¤„ç† APK æ–‡ä»¶ï¼ˆåŠ æ¶æ„åç¼€ï¼‰
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              original_filename=$(basename "$file")
              
              # luci-* æ˜¯é€šç”¨åŒ…ï¼Œä¸åŠ æ¶æ„åç¼€
              if [[ "$original_filename" == luci-* ]]; then
                if [ -f "$RELEASE_DIR/$original_filename" ]; then
                  echo "  â­ï¸  APK (è·³è¿‡): $original_filename"
                else
                  cp "$file" "$RELEASE_DIR/"
                  echo "  âœ… APK (é€šç”¨): $original_filename"
                  APK_COUNT=$((APK_COUNT + 1))
                fi
              else
                # å…¶ä»– APK åŠ æ¶æ„åç¼€
                base_name="${original_filename%.apk}"
                new_filename="${base_name}_${arch}.apk"
                
                cp "$file" "$RELEASE_DIR/$new_filename"
                echo "  âœ… APK: $new_filename"
                APK_COUNT=$((APK_COUNT + 1))
              fi
            fi
          done < <(find "$artifact_dir" -type f -name "*.apk" 2>/dev/null)
          
          echo ""
        done
        
        FINAL_IPK=$(find "$RELEASE_DIR" -type f -name "*.ipk" 2>/dev/null | wc -l)
        FINAL_APK=$(find "$RELEASE_DIR" -type f -name "*.apk" 2>/dev/null | wc -l)
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "IPK: $FINAL_IPK ä¸ª"
        echo "APK: $FINAL_APK ä¸ª"
        echo "æ€»è®¡: $((FINAL_IPK + FINAL_APK)) ä¸ª"
        echo ""
        
        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV

    - name: ğŸš€ å‘å¸ƒåˆ° GitCode å’Œ Gitee
      env:
        GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        GITCODE_USERNAME: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
        GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        GITEE_USERNAME: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
        REPO_NAME: ${{ matrix.project.local_name }}
        TAG_NAME: ${{ matrix.project.version }}
        RELEASE_TITLE: "${{ matrix.project.local_name }} ${{ matrix.project.version }}"
      run: |
        # åŠ¨æ€ç”Ÿæˆæ„å»ºæ—¶é—´
        BUILD_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        
        # ç”Ÿæˆ Release Body
        RELEASE_BODY="## ğŸ“¦ ${{ matrix.project.local_name }} ${{ matrix.project.version }}

        ### ğŸ“Œ é¡¹ç›®ä¿¡æ¯
        - é¡¹ç›®åç§°: ${{ matrix.project.github_repo }}
        - é¡¹ç›®ç‰ˆæœ¬: ${{ matrix.project.version }}
        - ä¸Šæ¸¸ä»“åº“: https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}
        - ä¸Šæ¸¸åœ°å€: https://github.com/${{ matrix.project.github_owner }}/${{ matrix.project.github_repo }}/releases/tag/${{ matrix.project.version }}

        ### ğŸ”¨ æ„å»ºä¿¡æ¯
        - æ„å»ºæ—¶é—´: ${BUILD_TIME} (åŒ—äº¬æ—¶é—´)
        - å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        - æ¶æ„æ•°é‡: 33 ä¸ª
        - SDK ç‰ˆæœ¬: OpenWrt 24.10 + SNAPSHOT"
        
        # âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ä¸´æ—¶ç›®å½•
        UPLOAD_FILES=$(find "$RELEASE_DIR" -type f \( -name "*.ipk" -o -name "*.apk" \) | tr '\n' ' ')
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "å‡†å¤‡å‘å¸ƒ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "æ–‡ä»¶æ•°é‡: $(echo $UPLOAD_FILES | wc -w)"
        echo "æ„å»ºæ—¶é—´: $BUILD_TIME"
        echo ""
        
        # ä¸²è¡Œå‘å¸ƒ
        
        # ç¬¬ä¸€æ­¥ï¼šå‘å¸ƒåˆ° GitCode
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ å‘å¸ƒåˆ° GitCode"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        GITCODE_TOKEN="$GITCODE_TOKEN" \
        USERNAME="$GITCODE_USERNAME" \
        REPO_NAME="$REPO_NAME" \
        TAG_NAME="$TAG_NAME" \
        RELEASE_TITLE="$RELEASE_TITLE" \
        RELEASE_BODY="$RELEASE_BODY" \
        UPLOAD_FILES="$UPLOAD_FILES" \
        .github/workflows/scripts/release-GitCode.sh
        
        GITCODE_STATUS=$?
        
        if [ $GITCODE_STATUS -eq 0 ]; then
          echo "âœ… GitCode å‘å¸ƒæˆåŠŸ"
        else
          echo "âŒ GitCode å‘å¸ƒå¤±è´¥"
        fi
        
        echo ""
        
        # ç¬¬äºŒæ­¥ï¼šå‘å¸ƒåˆ° Gitee
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ å‘å¸ƒåˆ° Gitee"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        GITEE_TOKEN="$GITEE_TOKEN" \
        USERNAME="$GITEE_USERNAME" \
        REPO_NAME="$REPO_NAME" \
        TAG_NAME="$TAG_NAME" \
        RELEASE_TITLE="$RELEASE_TITLE" \
        RELEASE_BODY="$RELEASE_BODY" \
        UPLOAD_FILES="$UPLOAD_FILES" \
        .github/workflows/scripts/release-gitee.sh
        
        GITEE_STATUS=$?
        
        if [ $GITEE_STATUS -eq 0 ]; then
          echo "âœ… Gitee å‘å¸ƒæˆåŠŸ"
        else
          echo "âŒ Gitee å‘å¸ƒå¤±è´¥"
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š å‘å¸ƒç»“æœ"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "GitCode: $([ $GITCODE_STATUS -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
        echo "Gitee:   $([ $GITEE_STATUS -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        if [ $GITCODE_STATUS -ne 0 ] && [ $GITEE_STATUS -ne 0 ]; then
          echo "::error::ä¸¤ä¸ªå¹³å°éƒ½å‘å¸ƒå¤±è´¥"
          exit 1
        fi

    - name: æ›´æ–°ç‰ˆæœ¬è®°å½•åˆ° version.txt
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ æ›´æ–°ç‰ˆæœ¬è®°å½•"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # å†™å…¥ç‰ˆæœ¬
        .github/workflows/scripts/version-manager.sh write \
          "${{ matrix.project.local_name }}" \
          "${{ matrix.project.version }}"
        
        # æ£€æŸ¥å·¥ä½œç›®å½•ï¼ˆç¡®ä¿åªæœ‰ version.txt è¢«ä¿®æ”¹ï¼‰
        echo ""
        echo "Git çŠ¶æ€:"
        git status --short
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # åªæ·»åŠ  version.txt
        git add version.txt
        
        # éªŒè¯æš‚å­˜åŒº
        STAGED=$(git diff --cached --name-only)
        echo ""
        echo "å³å°†æäº¤: $STAGED"
        
        if [ "$STAGED" != "version.txt" ]; then
          echo "::error::æ£€æµ‹åˆ° version.txt ä»¥å¤–çš„æ–‡ä»¶è¢«æš‚å­˜ï¼"
          exit 1
        fi
        
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ“ æ›´æ–°ç‰ˆæœ¬è®°å½•: ${{ matrix.project.local_name }} -> ${{ matrix.project.version }}"
          git pull --rebase origin ${{ github.ref_name }} || true
          git push origin ${{ github.ref_name }}
          echo "âœ… ç‰ˆæœ¬è®°å½•å·²æ›´æ–°"
        else
          echo "â„¹ï¸  ç‰ˆæœ¬è®°å½•æ— å˜åŒ–"
        fi
          
  # ç”ŸæˆæŠ¥å‘Š                                                   
 report:
  runs-on: ubuntu-latest
  needs: [check-updates, build, release]
  if: always()
  
  steps:
    - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      run: |
        # è·å–çŠ¶æ€
        HAS_UPDATES="${{ needs.check-updates.outputs.has_updates }}"
        BUILD_STATUS="${{ needs.build.result }}"
        RELEASE_STATUS="${{ needs.release.result }}"
        MATRIX='${{ needs.check-updates.outputs.matrix }}'
        
        # ç”Ÿæˆæ—¶é—´
        BUILD_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        
        # åˆ¤æ–­çŠ¶æ€
        if [ "$HAS_UPDATES" = "true" ]; then
          VERSION_CHECK_STATUS="âœ… å‘ç°æ›´æ–°"
        else
          VERSION_CHECK_STATUS="â„¹ï¸  æ— æ›´æ–°"
        fi
        
        if [ "$BUILD_STATUS" = "success" ]; then
          BUILD_CHECK_STATUS="âœ… æˆåŠŸ"
        elif [ "$BUILD_STATUS" = "skipped" ]; then
          BUILD_CHECK_STATUS="â­ï¸ è·³è¿‡"
        else
          BUILD_CHECK_STATUS="âŒ å¤±è´¥"
        fi
        
        if [ "$RELEASE_STATUS" = "success" ]; then
          RELEASE_CHECK_STATUS="âœ… æˆåŠŸ"
        elif [ "$RELEASE_STATUS" = "skipped" ]; then
          RELEASE_CHECK_STATUS="â­ï¸ è·³è¿‡"
        else
          RELEASE_CHECK_STATUS="âŒ å¤±è´¥"
        fi
        
        # è§£æé¡¹ç›®ä¿¡æ¯
        if [ "$MATRIX" != '{"include":[]}' ] && [ -n "$MATRIX" ]; then
          PROJECT_COUNT=$(echo "$MATRIX" | jq '.include | length')
          PROJECT_LIST=$(echo "$MATRIX" | jq -r '.include[] | "- **\(.local_name)** (\(.github_owner)/\(.github_repo)) â†’ `\(.version)`"')
        else
          PROJECT_COUNT=0
          PROJECT_LIST="æ— "
        fi
        
        # ç”ŸæˆæŠ¥å‘Š
        cat >> $GITHUB_STEP_SUMMARY << EOF
        # ğŸ“¦ OpenWrt è½¯ä»¶åŒ…æ„å»ºæŠ¥å‘Š
        
        **è§¦å‘æ—¶é—´**: ${BUILD_TIME} (åŒ—äº¬æ—¶é—´)  
        **å¼ºåˆ¶æ„å»º**: ${{ inputs.force_build }}  
        **å·¥ä½œæµ**: [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        
        ---
        
        ## ğŸ“Š ä»»åŠ¡çŠ¶æ€
        
        | é˜¶æ®µ | çŠ¶æ€ |
        |------|------|
        | ç‰ˆæœ¬æ£€æŸ¥ | ${VERSION_CHECK_STATUS} |
        | è½¯ä»¶åŒ…æ„å»º | ${BUILD_CHECK_STATUS} |
        | æ–‡ä»¶å‘å¸ƒ | ${RELEASE_CHECK_STATUS} |
        
        ---
        
        ## ğŸ“‹ é¡¹ç›®åˆ—è¡¨
        
        **é¡¹ç›®æ•°é‡**: ${PROJECT_COUNT}
        
        ${PROJECT_LIST}
        
        EOF
        
        # æ ¹æ®æ„å»ºç»“æœæ·»åŠ è¯¦ç»†ä¿¡æ¯
        if [ "$HAS_UPDATES" = "true" ]; then
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ---
        
        ## ğŸ”¨ æ„å»ºè¯¦æƒ…
        
        ### æ¶æ„æ”¯æŒ
        - **æ¶æ„æ•°é‡**: 33 ä¸ª
        - **SDK ç‰ˆæœ¬**: OpenWrt 24.10 + SNAPSHOT
        - **æ–‡ä»¶æ ¼å¼**: IPKï¼ˆOpenWrt 24.10ï¼‰+ APKï¼ˆSNAPSHOTï¼‰
        
        ### å‘å¸ƒå¹³å°
        - ğŸŒ **GitCode**: https://gitcode.com/${{ secrets.GITCODE_USERNAME || 'whzhni' }}
        - ğŸŒ **Gitee**: https://gitee.com/${{ secrets.GITEE_USERNAME || 'whzhni' }}
        
        ### æ„å»ºç»Ÿè®¡
        EOF
          
          # éå†é¡¹ç›®æ˜¾ç¤º Release é“¾æ¥
          echo "$MATRIX" | jq -r '.include[]' | while read -r project; do
            local_name=$(echo "$project" | jq -r '.local_name')
            version=$(echo "$project" | jq -r '.version')
            
            cat >> $GITHUB_STEP_SUMMARY << EOF
        
        **${local_name}** (${version}):
        - GitCode: https://gitcode.com/${{ secrets.GITCODE_USERNAME || 'whzhni' }}/${local_name}/releases/tag/${version}
        - Gitee: https://gitee.com/${{ secrets.GITEE_USERNAME || 'whzhni' }}/${local_name}/releases/tag/${version}
        EOF
          done
        else
          cat >> $GITHUB_STEP_SUMMARY << EOF
        ---
        
        ## â„¹ï¸  æ— éœ€æ„å»º
        
        å½“å‰æ‰€æœ‰é¡¹ç›®å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡æ„å»ºæµç¨‹ã€‚
        
        å¦‚éœ€å¼ºåˆ¶é‡æ–°æ„å»ºï¼Œè¯·ä½¿ç”¨ **Force build** é€‰é¡¹æ‰‹åŠ¨è§¦å‘ã€‚
        EOF
        fi
        
        # ç”Ÿæˆ Annotation
        if [ "$HAS_UPDATES" = "true" ]; then
          if [ "$BUILD_STATUS" = "success" ] && [ "$RELEASE_STATUS" = "success" ]; then
            echo "::notice title=âœ… æ„å»ºæˆåŠŸ::æ‰€æœ‰é¡¹ç›®å·²æˆåŠŸæ„å»ºå¹¶å‘å¸ƒ"
          elif [ "$BUILD_STATUS" = "success" ] && [ "$RELEASE_STATUS" != "success" ]; then
            echo "::warning title=âš ï¸ å‘å¸ƒå¤±è´¥::æ„å»ºæˆåŠŸä½†å‘å¸ƒè¿‡ç¨‹å‡ºç°é”™è¯¯"
          else
            echo "::error title=âŒ æ„å»ºå¤±è´¥::æ„å»ºæˆ–å‘å¸ƒè¿‡ç¨‹å‡ºç°é”™è¯¯"
          fi
        else
          echo "::notice title=â„¹ï¸ æ— éœ€æ›´æ–°::å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi
